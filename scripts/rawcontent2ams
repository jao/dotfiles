#!/bin/bash

# this script takes the raw structure and generates the AMS structure
# followed by yet another script that will generate the necessary XML
# files, with the required information.
# The ruby script is called: amsxmlgenerator

# Basic variables
SCRIPT_NAME=`basename $0`
SCRIPT_DIR=`dirname $0`
source "${SCRIPT_DIR}/_function_colorize"

CONTENT_SOURCE_DIRECTORY="/Volumes/PublicoSP/remoteITcontents/raw_content"
CONTENT_TARGET_DIRECTORY="/Volumes/PublicoSP/remoteITcontents/ams"

DATETIME="201010110600"

_rename_files_properly () {
  cd $1
  for file in `ls`; do
    newfilename=`echo $file | tr "[[:upper:]]" "[[:lower:]]"`
    newfilename="${newfilename//[/}"
    newfilename="${newfilename//]/_}"
    newfilename="${newfilename//(/}"
    newfilename="${newfilename//)/_}"
    newfilename="${newfilename//__/_}"
    if [ "$file" != "$newfilename" ]; then
      colorize "  $file => $newfilename" 36
      mv -v $file $newfilename
    fi
  done
  cd -
}

_rename_files_no_spaces () {
  ls | while read filename; do
    if [ -e "$filename" ] && [ "$filename" != "${filename// /}" ]; then
      mv "$filename" "${filename// /}";
    fi
  done
}

cd $CONTENT_SOURCE_DIRECTORY
for mediatype in `ls`; do
  cd $mediatype
  for provider in `ls`; do
    cd $provider
    for content_pack in `ls`; do
      cd $content_pack
      
      # set the renamed providers to their new names (hardcoded)
      case $provider in
        avioesdoforro|forrodomuido) provider_name="ezapsom";;
        bella) provider_name="belladasemana";;
        cesarpolvilho) provider_name="eblasperez";;
        concursosereias) provider_name="sereias";;
        hsm) provider_name="disney";;
        fugu) provider_name="fugumobile";;
        smartcontents) provider_name="sensualclub";;
        taito) provider_name="fatorx";;
        wtn) provider_name="mobbr";;
        *) provider_name="$provider";;
      esac
      
      case $mediatype in
        games)
          pack_name="${DATETIME}_game_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          colorize "content pack: $pack_name ($target_dir)" 32
          
          [ -f ICO_WEB.GIF ] && convert -size 100x100 ICO_WEB.GIF -thumbnail 100x100! $target_dir/_wap_preview.jpg
          [ -f ICO_WEB.GIF ] && convert -size 200x200 ICO_WEB.GIF -thumbnail 200x200! $target_dir/_web_preview.jpg
          
          [ -f INFO.TXT ] && cp -n INFO.TXT $target_dir/info.txt
          [ -f SHORT.TXT ] && cp -n INFO.TXT $target_dir/short.txt
          [ -f LONG.TXT ] && cp -n INFO.TXT $target_dir/long.txt
          
          # java files directory
          [ ! -d $target_dir/files ] && mkdir -p $target_dir/files
          
          _rename_files_no_spaces
          
          regexp="(ALCATEL|AMOI|BENQ|BLACKBERRY|HTC|HUAWEI|KYOCERA|LG|MOTOROLA|NEC|NOKIA|PANASONIC|PANTECH|SAGEM|SAMSUNG|SANYO|SHARP|SIEMENS|SONY.?ERICSSON|TOSHIBA|ZTE)"
          for file in `ls *.JA* | grep -Ei "$regexp"`; do
            new_filename=`echo $file | sed -E "s/${regexp}/\1_/g" | sed -E 's/SONY.ERICSSON/SONYERICSSON/' | sed 's/__/_/g' | tr "[[:upper:]]" "[[:lower:]]" | sed 's/(_en|_it)//g'`
            cp -nv "$file" $target_dir/files/$new_filename
          done
          rm $target_dir/files/*.dm
          
          # _rename_files_properly "${target_dir}"
        ;;
        images)
          pack_name="${DATETIME}_image_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          colorize "content pack: $pack_name ($target_dir)" 32
          
          for image in `ls | grep -Ei 'jpg$'`; do
            image_name=${image#*_}
            image_name=${image_name%_SQR*}
            image_name=${image_name%_RET*}
            image_name=${image_name%.*}
            
            # image resolution
            resolution=`identify $image | awk '{ print $3 }'`
            width=`echo $resolution | awk -Fx '{ print $1 }'`
            height=`echo $resolution | awk -Fx '{ print $2 }'`
            
            # ratio information
            if [ $(($width / 4)) -eq $(($height / 3)) ]; then
              ratio_square="-crop ${height}x${height}"
              ratio_landscape=""
              ratio_portrait="-crop $(( $height / 4 * 3 ))x${height}"
            elif [ $(($width / 3)) -eq $(($height / 4)) ]; then
              ratio_square="-crop ${width}x${width}"
              ratio_landscape="-crop $(( $width / 4 * 3 ))x${width}"
              ratio_portrait=""
            else
              ratio_square=""
              ratio_landscape="-crop ${width}x$(( $width / 4 * 3 ))"
              ratio_portrait="-crop $(( $width / 4 * 3 ))x${width}"
            fi
            
            # information csv file
            [ ! -f $target_dir/images.csv ] && echo "provider, content pack, resolution, original file name, new file name" > $target_dir/images.csv
            echo "${provider_name}, ${content_pack}, ${resolution}, ${image}, ${image_name}_image" >> $target_dir/images.csv
            
            convert -size 1200x1200 $image -resize 1200x1200! $target_dir/${image_name}_image_1200x1200.jpg
            convert -size 1200x900 $image -resize 1200x900! $target_dir/${image_name}_image_1200x900.jpg
            convert -size 900x1200 $image -resize 900x1200! $target_dir/${image_name}_image_900x1200.jpg
            convert -size 675x1200 $image -resize 675x1200! $target_dir/${image_name}_image_675x1200.jpg
          done
          
          _rename_files_properly "${target_dir}"
        ;;
        songs)
          pack_name="${DATETIME}_realsound_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          colorize "content pack: $pack_name ($target_dir)" 32
          
          [ -f ICO_WEB.GIF ] && convert -size 100x100 ICO_WEB.GIF -thumbnail 100x100! $target_dir/_wap_preview.jpg
          [ -f ICO_WEB.GIF ] && convert -size 200x200 ICO_WEB.GIF -thumbnail 200x200! $target_dir/_web_preview.jpg
          cp -n *.MP3 ${target_dir}/
          rm $target_dir/*_PREVIEW.MP3
          
          _rename_files_properly "${target_dir}"
        ;;
        videos)
          pack_name="${DATETIME}_video_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          colorize "content pack: $pack_name ($target_dir)" 32
          
          # sizes
          sizes=('176x144' '352x288')
          # parameters
          video_options="-b 100k -r 13"
          audio_options="-strict experimental -ab 60k -ar 22050"
          qcomp="-qcomp 0.5" # compression
          
          for video in `ls | grep -Ei '(3gp|mp4)$'`; do
            ref_size=`echo ${video##_*} | tr "[[:upper:]]" "[[:lower:]]"`
            ref_width=`echo $ref_size | awk -Fx '{ print $1 }'`
            ref_height=`echo $ref_size | awk -Fx '{ print $2 }'`
            
            videoname=${video%*_}
            videoname=${videoname#.*}
            videoname_lowercase=`echo $videoname | tr "[[:upper:]]" "[[:lower:]]"`
            
            # information csv file
            [ ! -f $target_dir/videos.csv ] && echo "provider, content pack, resolution, original file name, new file name" > $target_dir/videos.csv
            echo "${provider_name}, ${content_pack}, ${ref_size}, ${video}, ${videoname_lowercase}_video" >> $target_dir/videos.csv
            
            preview="ICO_WEB_${videoname}.GIF"
            if [ -f $preview ]; then
              convert -size 200x200 $preview -thumbnail 200x200! $target_dir/${videoname_lowercase}_video_web_preview.jpg
              convert -size 100x100 $preview -thumbnail 100x100! $target_dir/${videoname_lowercase}_video_wap_preview.jpg
              convert -size 600x600 $preview -resize 600x600! $target_dir/${videoname_lowercase}_video_cover_600x600.jpg
            else
              colorize "  missing file $preview" 33
            fi
            # screen capture
            ffmpeg -i $video -f image2 -ss 4 -t 2 -r 1:4 -s 640x480 _${videoname}_640x480_%02d.jpg &> /dev/null
            convert -size 640x480 _${videoname}_640x480_002.jpg -resize 640x480! $target_dir/${videoname_lowercase}_video_screen_capture_640x480.jpg
            rm _${videoname}_640x480_*.jpg
            
            for size in ${sizes[@]}; do
              new_width=`echo $size | awk -Fx '{ print $1 }'`
              new_height=`echo $size | awk -Fx '{ print $2 }'`
              
              # aspect ratio calculation
              if [ $(($new_width / 4)) -eq $(($new_height / 3)) ]; then
                aspect_param="-aspect 4:3"
              elif [ $(($new_width / 3)) -eq $(($new_height / 2)) ]; then
                aspect_param="-aspect 3:2"
              elif [ $(($new_width / 16)) -eq $(($new_height / 9)) ]; then
                aspect_param="-aspect 16:9"
              elif [ $(($new_width / 11)) -eq $(($new_height / 9)) ]; then
                aspect_param="-aspect 11:9"
              else
                aspect_param=""
              fi
              
              # 3gp
              new_video="${target_dir}/${videoname_lowercase}_video_mpeg4_aac_${size}.3gp"
              if [ ! -f "$new_video" ]; then
                colorize "    $video => $new_video" 36
                colorize "      ffmpeg -i $video -f 3gp -vcodec mpeg4 $video_options -acodec aac $audio_options -s $size $aspect_param $qcomp -y $new_video"
                ffmpeg -i $video -f 3gp -vcodec mpeg4 $video_options -acodec aac $audio_options -s $size $aspect_param $qcomp -y $new_video 2>&1 | grep -Ei '(damaged|error|problem|failed)'
              fi
            done
          done
          
          _rename_files_properly "${target_dir}"
        ;;
      esac
      cd ..
    done
    cd ..
  done
  cd ..
done

exit $?
