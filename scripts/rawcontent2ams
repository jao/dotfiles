#!/bin/bash

# this script takes the raw structure and generates the AMS structure
# followed by yet another script that will generate the necessary XML
# files, with the required information.
# The ruby script is called: amsxmlgenerator

# Basic variables
SCRIPT_NAME=`basename $0`
SCRIPT_DIR=`dirname $0`
source "${SCRIPT_DIR}/_function_colorize"

CONTENT_SOURCE_DIRECTORY="/Volumes/PublicoSP/remoteITcontents/raw_content"
CONTENT_TARGET_DIRECTORY="/Volumes/PublicoSP/remoteITcontents/ams"

DATETIME="201010110600"

_rename_files_properly () {
  cd $1
  for file in `ls`; do
    newfilename=`echo $file | tr "[[:upper:]]" "[[:lower:]]"`
    newfilename="${newfilename//[/}"
    newfilename="${newfilename//]/_}"
    newfilename="${newfilename//(/}"
    newfilename="${newfilename//)/_}"
    newfilename="${newfilename//__/_}"
    if [ "$file" != "$newfilename" ]; then
      colorize "  $file => $newfilename" 36
      mv -v $file $newfilename
    fi
  done
  cd -
}

cd $CONTENT_SOURCE_DIRECTORY
for mediatype in `ls`; do
  cd $mediatype
  for provider in `ls`; do
    cd $provider
    for content_pack in `ls`; do
      cd $content_pack
      
      # set the renamed providers to their new names (hardcoded)
      case $provider in
        avioesdoforro|forrodomuido) provider_name="ezapsom";;
        bella) provider_name="belladasemana";;
        cesarpolvilho) provider_name="eblasperez";;
        concursosereias) provider_name="sereias";;
        hsm) provider_name="disney";;
        fugu) provider_name="fugumobile";;
        smartcontents) provider_name="sensualclub";;
        taito) provider_name="fatorx";;
        wtn) provider_name="mobbr";;
        *) provider_name="$provider";;
      esac
      
      case $mediatype in
        games)
          pack_name="${DATETIME}_game_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          
          [ -f ICO_WAP.GIF ] && convert ICO_WAP.GIF -thumbnail 30x30 $target_dir/_wap_preview.jpg
          [ -f ICO_WEB.GIF ] && convert ICO_WEB.GIF -thumbnail 200x200 $target_dir/_web_preview.jpg
          cp -nv *.JA* $target_dir/
          
          _rename_files_properly "${target_dir}"
        ;;
        images)
          pack_name="${DATETIME}_image_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          
          for image in `ls | grep -Ei 'jpg$'`; do
            image_name=${image#*_}
            image_name=${image_name%_SQR*}
            image_name=${image_name%_RET*}
            image_name=${image_name%.*}
            
            echo -n "${provider_name}, ${content_pack}. ${image}" > $target_dir/${image_name}_image.txt
            convert -size 1200x1200 $image -resize 1200x1200 $target_dir/${image_name}_image_1200x1200.jpg
            convert -size 1200x900 $image -resize 1200x900 $target_dir/${image_name}_image_1200x900.jpg
            convert -size 900x1200 $image -resize 900x1200 $target_dir/${image_name}_image_900x1200.jpg
            convert -size 675x1200 $image -resize 675x1200 $target_dir/${image_name}_image_675x1200.jpg
          done
          
          _rename_files_properly "${target_dir}"
        ;;
        songs)
          pack_name="${DATETIME}_realsound_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          
          [ -f ICO_WEB.GIF ] && convert -size 100x100 ICO_WEB.GIF -thumbnail 100x100 $target_dir/_wap_preview.jpg
          [ -f ICO_WEB.GIF ] && convert -size 200x200 ICO_WEB.GIF -thumbnail 200x200 $target_dir/_web_preview.jpg
          cp -n *.MP3 ${target_dir}/
          rm $target_dir/*_PREVIEW.MP3
          
          _rename_files_properly "${target_dir}"
        ;;
        videos)
          pack_name="${DATETIME}_video_${provider_name}_${content_pack}_insert"
          target_dir="${CONTENT_TARGET_DIRECTORY}/${pack_name}"
          [ ! -d $target_dir ] && mkdir -p $target_dir
          touch $target_dir/$pack_name.xml
          
          # sizes
          sizes=('176x144' '352x288')
          # parameters
          video_options="-b 100k -r 13"
          audio_options="-ab 30k -ar 22050"
          qcomp=" -qcomp 0.5" # compression
          
          for video in `ls | grep -Ei '3gp$'`; do
            ref_size=${video##_*}
            ref_width=`echo $ref_size | awk -FX '{ print $1 }'`
            ref_height=`echo $ref_size | awk -FX '{ print $2 }'`
            
            videoname=${video%*_}
            videoname=${videoname#.*}
            videoname_lowercase=`echo $videoname | tr "[[:upper:]]" "[[:lower:]]"`
            
            preview="ICO_WEB_${videoname}.GIF"
            if [ -f $preview ]; then
              convert -size 200x200 $preview -thumbnail 200x200 $target_dir/${videoname_lowercase}_video_web_preview.jpg
              convert -size 100x100 $preview -thumbnail 100x100 $target_dir/${videoname_lowercase}_video_wap_preview.jpg
              convert -size 600x600 $preview -resize 600x600 $target_dir/${videoname_lowercase}_video_cover_600x600.jpg
            fi
            # screen capture
            ffmpeg -i $video -f image2 -ss 4 -t 2 -r 1:3 -s 640x480 _${videoname}_640x480_%02d.jpg &> /dev/null
            convert -size 640x480 _${videoname}_640x480_002.jpg -resize 640x480 $target_dir/${videoname_lowercase}_video_screen_capture_640x480.jpg
            rm _${videoname}_640x480_*.jpg
            
            # information file
            echo -n "${provider_name}, ${content_pack}, ${video}" > $target_dir/${videoname_lowercase}_video.txt
            
            for size in ${sizes[@]}; do
              new_width=`echo $size | awk -Fx '{ print $1 }'`
              new_height=`echo $size | awk -Fx '{ print $2 }'`
              
              if [ "$new_width" -le "$ref_width" ] && [ "$new_height" -le "$ref_height" ]; then
                if [ $(($new_width / 4)) -eq $(($new_height / 3)) ]; then
                  aspect="4:3"
                  aspect_param=" -aspect 4:3"
                elif [ $(($new_width / 3)) -eq $(($new_height / 2)) ]; then
                  aspect="3:2"
                  aspect_param=" -aspect 3:2"
                elif [ $(($new_width / 16)) -eq $(($new_height / 9)) ]; then
                  aspect="16:9"
                  aspect_param=" -aspect 16:9"
                elif [ $(($new_width / 11)) -eq $(($new_height / 9)) ]; then
                  aspect="11:9"
                  aspect_param=" -aspect 11:9"
                else
                  aspect="unknown"
                  aspect_param=""
                fi
                # 3gp
                new_video="${target_dir}/${videoname_lowercase}_video_mpeg4_aac_${size}.3gp"
                if [ ! -f "$new_video" ]; then
                  colorize "    ${video} => ${new_video}" 36
                  colorize "      ffmpeg -i ${video} -vcodec mpeg4 ${video_options} -acodec aac ${audio_options} -s ${size}${aspect_param}${qcomp} -y -f 3gp ${new_video}"
                  ffmpeg -i $video -vcodec mpeg4 $video_options -acodec aac $audio_options -s ${size}${aspect_param}${qcomp} -y -f 3gp $new_video 2>&1 | grep -Ei '(damaged|error|problem|failed)'
                fi
              fi
            done
          done
          
          _rename_files_properly "${target_dir}"
        ;;
      esac
      cd ..
    done
    cd ..
  done
  cd ..
done

exit $?
